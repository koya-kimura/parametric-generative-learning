# 教授との面談メモ

## 概要

- 日時：2025年5月21日 13:10-
- 内容：CNNなどを用いて画像からパラメータを取り出す

---

## 主なトピック

### 1. 前回からの画像生成システムの改善要素

- csvを読み込むというシステムを追加
- 画像を保存するか否かを選択できる機能を追加

### 2. CNNを用いた画像パラメータ抽出

- `dipCount` 単体を予測するモデル（`image2dipcount_single.ipynb`）を完成。
  - 画像と `dipCount` のペアを使った回帰モデルを学習。
  - 損失関数には `MSELoss`、最適化手法は `Adam`。
  - 学習後はロスカーブと画像上の予測/真値を比較する可視化を行った。
- 複数パラメータに対応する拡張モデル（`image2params_multi.ipynb`）を新たに構築。
  - 出力を `[dipCount, hue_cos, hue_sin]` の3次元ベクトルとする。
  - `hue` はラジアンに変換して `(cos, sin)` 表現にし、周期性に対応。
- `MultiParamDataset` を定義し、`dipCount`と`hue`の変換をラベルとして返す構成に変更。
- `MultiParamCNN` では、最終出力層を3ユニットとし、マルチ出力に対応。
- `tqdm` を用いて学習進捗を視覚化し、`torchinfo.summary()` でモデル構造を確認。
- Mac (M1/M2) への対応として `cuda` / `mps` / `cpu` の自動判定機構を導入。
- 検証結果の可視化においては、予測された `hue` を `arctan2` により角度に戻し、真値と比較。
- Stepごとにテスト＆可視化ブロックを追加することで、進行の理解とデバッグが容易に。

---

### 3. 今後の検討事項

- `hue` の角度誤差（周期的距離）を数値評価する指標の導入
- 他パラメータ（`circleCount`, `asp`, `startAngle` など）を含めた出力次元の拡張
- `torch.save` / `torch.load` による学習済みモデルの保存と推論再利用
- モデル予測の分布（散布図、誤差ヒストグラムなど）を使った性能評価の可視化

---

## 議論内容（ディスカッションログ）2025年5月21日

### 1. 正規化とロス関数設計に関する検討

- dipCountとhue_cos/sinでは値のスケールが大きく異なるため、2乗誤差（MSELoss）ではdipCountの影響が支配的になる。
- 各ラベルを正規化した上で学習する方針が望ましく、CSV読み込み直後の`df_targets`で正規化処理を行うのが自然である。
- 各ラベルに対するロスの重み付けを行えるように、ロス関数の設計を柔軟にしておく必要がある。
- 重みの比率は、各パラメータを単体で学習した際のロス値を基準に調整できる。
- 正規化による学習安定性向上と、ロスバランスの制御による多目的学習の質の向上が期待される。

### 2. dipCountの扱いと評価について

- dipCountは整数値であるため、予測結果に対して`round()`で四捨五入することでより自然な評価が可能。
- 分類ラベルとして扱うにはクラス数が多すぎるため、回帰のままでの学習が妥当という認識。
- scalarGANのように、連続値のまま取り扱うことで生成モデルとの接続もスムーズになる。

### 3. 予測パラメータの拡張とビジュアル多様性

- 次のステップとして、circleCountやasp、startAngleといった他のパラメータも予測対象に加えていく。
- 現状の実装ではcircleCountが使われていない可能性があり、学習にどのパラメータが実際に効いているかを検証する必要がある。
- ビジュアルの種類が1種類に固定されているため、今後は生成される画像のバリエーションも増やしていく方向が望ましい。

### 4. 評価器の構築とGANへの応用展望

- 収集した主観評価データをもとに、評価スコアを出力する評価モデルの構築を検討。
- 評価スコアを本物・偽物の区別に用いることで、GANにおけるdiscriminatorのような使い方が可能になる。
- 高評価な画像を用いて生成モデルを強化したり、逆に低評価データを使って「好ましくない画像」を学習させる応用もありうる。

### 5. 潜在空間圧縮とVAE的アプローチ

- 現在は特徴ベクトルの次元が64となっているが、同等の性能を維持したまま次元削減が可能かを試す価値がある。
- オートエンコーダ（AE/VAE）を使って「どこまで圧縮できるか」を調べる実験も将来的には行う。
- VAEの構造や目的については現時点で十分に理解できていないため、今後の学習課題とする。

### 6. wandbのトラブルと運用注意点

- wandb使用中にクラッシュする事例が発生。`wandb.finish()` を明示的に呼ぶことで改善。
- 今後は学習ループの先頭で `wandb.finish()` を常に挟む方針とする。
- M1/M2 MacにおけるMPSデバイスとwandbの相性による不安定性も考慮が必要。

## 次回に向けたネクストアクション

- ラベルの正規化とロス関数の重み調整を実装する
- circleCountなど他のパラメータを予測対象に加える
- hue予測の評価指標として角度誤差を導入する
- 評価スコアをラベルとした評価モデル（評価器）構築のプロトタイプを検討する