# CNNによるジェネレーティブ画像からの複数パラメータ予測【v2拡張版】

本ノートブックは、v1（`image2params_multi.ipynb`）で構築した CNNベースの画像→パラメータ予測モデルを、  
**より拡張性・精度・再利用性の高い形に強化**したバージョンです。

---

## 💡 v2での主なパワーアップ点

### ✅ 1. 複数パラメータ対応の拡張
- `dipCount` + `hue` に加え、**`circleCount`** を予測対象に追加
- 将来的な `startAngle` や `asp` にも対応可能な構成に再設計

### ✅ 2. 出力の正規化（Z-score）対応
- パラメータごとのスケール差を吸収し、**学習安定性を大幅改善**
- `normalization_params.json` に平均・分散を保存し、**推論時の逆変換にも対応**

### ✅ 3. `hue`のベクトル表現 + 正規化のハイブリッド対応
- `hue` を `cos` / `sin` に変換して周期性に対応（v1と同様）
- さらに正規化を加え、**モデルが適切に方向成分を学習できるよう最適化**

### ✅ 4. Weighted MSE Loss による損失の柔軟化
- `dipCount` や `circleCount` が `hue_cos/sin` より誤差の影響を強く受けやすいため、
- **出力ごとに重みを設定**し、バランスの取れた学習が可能に
```python
loss_weights = [1.0, 0.5, 0.5, 0.8]
```

### ✅ 5. 推論結果の逆正規化＋角度復元
- 推論後に `denormalize()` により人が読めるスケールに戻し、
- `hue_cos`, `hue_sin` から `deg(arctan2(...))` による**角度表示を復元**
- **視覚的な評価がより直感的に**

### ✅ 6. 構造の一元管理と拡張性
- `TARGET_COLS` に予測対象を集約 → DataLoader、モデル出力、可視化すべてに連携
- パラメータの追加・削除が**1行で反映**されるように改善

---

## 🔁 パイプライン全体（v2）

1. CSV読み込み・画像ファイル存在チェック
2. `TARGET_COLS` に基づくラベル抽出と正規化
3. `hue` → `(cos, sin)` 変換
4. `Dataset`・`DataLoader` 構築
5. 出力次元に応じた CNN モデル構築
6. Weighted MSE を用いた学習（`Adam`）
7. wandbによるロギングと損失推移可視化
8. 逆正規化と推論結果の角度復元による画像表示

---

## 📈 比較イメージ（v1 → v2）

| 機能                          | v1                      | v2                        |
|-------------------------------|--------------------------|-----------------------------|
| パラメータ数                 | dipCount, hue           | dipCount, hue, circleCount |
| hue表現                      | cos/sin                 | cos/sin（＋正規化）        |
| 損失関数                    | MSE                     | Weighted MSE               |
| パラメータ正規化             | ✗                       | Z-scoreで正規化            |
| 逆正規化による表示           | ✗                       | ◯（hueは角度に復元）       |
| TARGET_COLSによる集中管理    | △（部分的）             | ◯（全体で一元管理）        |

---

## 🔭 今後の発展

- `startAngle`, `asp` など他パラメータへの拡張
- 評価指標（角度誤差、分布ヒストグラムなど）の導入
- モデル保存＆推論用スクリプトの外部化
- 評価器（スコア回帰モデル）や生成モデルとの統合も視野に

---

## 📂 対応ノートブック

```
image2params_v2.ipynb  # 本プロジェクトの拡張版
```

---